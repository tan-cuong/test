<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Quáº£n lÃ½ tuyáº¿n â€“ tráº¡m â€“ chuyáº¿n xe â€“ trÆ°á»ng há»c</title>

<link rel="stylesheet"
 href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial; }
h3 { text-align:center; margin:5px; }

#container { display:flex; height:90vh; }

#sidebar {
  width:340px;
  border-right:1px solid #ccc;
  padding:10px;
  overflow-y:auto;
}

#map { flex:1; }

button, select {
  width:100%;
  margin-bottom:6px;
  padding:8px;
}

.info {
  background:#f4f4f4;
  padding:8px;
  margin-top:5px;
  font-size:14px;
}
</style>
</head>
<body>

<h3>ğŸ›£ï¸ Tuyáº¿n â€“ ğŸ“ Tráº¡m â€“ ğŸ›µ Chuyáº¿n xe â€“ ğŸ“ TrÆ°á»ng há»c (Quy NhÆ¡n)</h3>

<div id="container">
<div id="sidebar">

<button onclick="startDrawRoute()">â• Váº½ tuyáº¿n</button>
<button onclick="startAddStation()">ğŸ“ ThÃªm tráº¡m</button>

<h4>ğŸ“ Danh sÃ¡ch tráº¡m</h4>
<ul id="stationList"></ul>

<hr>

<h4>ğŸ›µ Äáº·t chuyáº¿n</h4>
<select id="fromStation"></select>
<select id="toStation"></select>
<button onclick="bookTrip()">ğŸš€ Äáº·t chuyáº¿n</button>

<div class="info" id="tripInfo">ChÆ°a cÃ³ chuyáº¿n</div>

</div>

<div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ================= Báº¢N Äá»’ =================
const map = L.map('map').setView([13.7829,109.2190],13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom:19
}).addTo(map);

let mode = null;

// ================= TUYáº¾N =================
let routePoints = [];
let routeLine = null;

function startDrawRoute() {
  mode = 'route';
  routePoints = [];
  if (routeLine) map.removeLayer(routeLine);
  alert("Click Ä‘á»ƒ váº½ tuyáº¿n");
}

// ================= TRáº M =================
let stations = [];

function startAddStation() {
  mode = 'station';
  alert("Click Ä‘á»ƒ thÃªm tráº¡m");
}

function renderStations() {
  const ul = document.getElementById("stationList");
  const from = document.getElementById("fromStation");
  const to = document.getElementById("toStation");

  ul.innerHTML = from.innerHTML = to.innerHTML = "";

  stations.forEach((s,i)=>{
    ul.innerHTML += `<li>${s.name}</li>`;
    from.innerHTML += `<option value="${i}">${s.name}</option>`;
    to.innerHTML += `<option value="${i}">${s.name}</option>`;
  });
}

// ================= ICON =================
const bikeIcon = L.icon({
  iconUrl:"https://cdn-icons-png.flaticon.com/512/2972/2972185.png",
  iconSize:[40,40],
  iconAnchor:[20,20]
});

const schoolIcon = L.icon({
  iconUrl:"https://cdn-icons-png.flaticon.com/512/2991/2991148.png",
  iconSize:[35,35],
  iconAnchor:[17,35]
});

let bikeMarker = null;

// ================= TÃNH KHOáº¢NG CÃCH =================
function distance(a,b) {
  const R = 6371;
  const dLat = (b[0]-a[0])*Math.PI/180;
  const dLng = (b[1]-a[1])*Math.PI/180;
  const lat1 = a[0]*Math.PI/180;
  const lat2 = b[0]*Math.PI/180;

  const x = Math.sin(dLat/2)**2 +
    Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}

function totalRouteDistance(p) {
  let d=0;
  for(let i=1;i<p.length;i++)
    d+=distance(p[i-1],p[i]);
  return d;
}

// ================= Äáº¶T CHUYáº¾N =================
function bookTrip() {
  if (stations.length<2 || routePoints.length<2) {
    alert("Cáº§n tráº¡m & tuyáº¿n trÆ°á»›c");
    return;
  }

  const from = stations[fromStation.value];
  const to = stations[toStation.value];

  if (bikeMarker) map.removeLayer(bikeMarker);

  bikeMarker = L.marker(from.latlng,{icon:bikeIcon}).addTo(map);

  const km = totalRouteDistance(routePoints);
  const speed = 30;
  const time = (km/speed*60).toFixed(1);

  tripInfo.innerHTML =
    `ğŸ“ QuÃ£ng Ä‘Æ°á»ng: ${km.toFixed(2)} km<br>
     â±ï¸ Thá»i gian dá»± kiáº¿n: ${time} phÃºt`;

  moveBike(to.latlng);
}

function moveBike(dest) {
  let i=0;
  const timer = setInterval(()=>{
    if (i>=routePoints.length) {
      clearInterval(timer);
      bikeMarker.setLatLng(dest);
      alert("ğŸ Xe Ä‘Ã£ tá»›i tráº¡m Ä‘Ã­ch");
      return;
    }
    bikeMarker.setLatLng(routePoints[i]);
    i++;
  },500);
}

// ================= CLICK MAP =================
map.on('click',e=>{
  if (mode==='route') {
    routePoints.push([e.latlng.lat,e.latlng.lng]);
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(routePoints,{color:'red'}).addTo(map);
  }

  if (mode==='station') {
    const name = prompt("TÃªn tráº¡m:");
    if (!name) return;

    const marker = L.marker(e.latlng).addTo(map);
    stations.push({name,latlng:e.latlng,marker});
    renderStations();
  }
});

// ================= TRÆ¯á»œNG Há»ŒC QUY NHÆ N =================
const schools = [
 {name:"Äáº¡i há»c Quy NhÆ¡n",lat:13.7819,lng:109.2194},
 {name:"THPT Quá»‘c Há»c Quy NhÆ¡n",lat:13.7812,lng:109.2168},
 {name:"THPT Tráº§n Cao VÃ¢n",lat:13.7708,lng:109.2226},
 {name:"THPT LÃª QuÃ½ ÄÃ´n",lat:13.7695,lng:109.2290},
 {name:"THCS Äá»‘ng Äa",lat:13.7739,lng:109.2214},
 {name:"Tiá»ƒu há»c Tráº§n Quá»‘c Toáº£n",lat:13.7763,lng:109.2172}
];

const schoolLayer = L.layerGroup().addTo(map);

schools.forEach(s=>{
  L.marker([s.lat,s.lng],{icon:schoolIcon})
   .bindPopup("ğŸ“ "+s.name)
   .addTo(schoolLayer);
});

L.control.layers(null,{
  "ğŸ“ TrÆ°á»ng há»c":schoolLayer
}).addTo(map);
</script>

</body>
</html>
